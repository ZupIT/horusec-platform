package vulnerability

import (
	"encoding/json"
	entityVulnerability "github.com/ZupIT/horusec-devkit/pkg/entities/vulnerability"
	"github.com/ZupIT/horusec-devkit/pkg/services/broker"
	"github.com/ZupIT/horusec-devkit/pkg/services/database/enums"
	"github.com/ZupIT/horusec-platform/vulnerability/internal/entities/vulnerability"
	repositoriesVulnerability "github.com/ZupIT/horusec-platform/vulnerability/internal/repositories/vulnerability"
)

type IController interface {
	FindAllVulnerabilityByFilter(
		filter *vulnerability.FilterToFindAllVulnerabilities) (*vulnerability.FindVulnerabilities, error)
	UpdateVulnerability(entity *vulnerability.UpdateVulnerability) error
}

type Controller struct {
	repoVulnerability repositoriesVulnerability.IRepositoryVulnerability
	broker broker.IBroker
}

func NewVulnerabilitiesController(repoVulnerability repositoriesVulnerability.IRepositoryVulnerability, iBroker broker.IBroker) IController {
	return &Controller{
		repoVulnerability: repoVulnerability,
		broker: iBroker,
	}
}

func (c *Controller) FindAllVulnerabilityByFilter(
	filter *vulnerability.FilterToFindAllVulnerabilities) (*vulnerability.FindVulnerabilities, error) {
	return c.repoVulnerability.FindAllVulnerabilitiesByFilter(filter)
}

func (c *Controller) UpdateVulnerability(entityToUpdate *vulnerability.UpdateVulnerability) error {
	vulnFound, err := c.repoVulnerability.GetVulnerabilityBYID(entityToUpdate.VulnerabilityID)
	if err != nil {
		return err
	}
	if vulnFound == nil {
		return enums.ErrorNotFoundRecords
	}
	if err := c.repoVulnerability.UpdateVulnerability(entityToUpdate); err != nil {
		return err
	}
	return c.publishToAnalytic(vulnFound, entityToUpdate)
}

func (c *Controller) publishToAnalytic(vulnFound *entityVulnerability.Vulnerability, entityToUpdate *vulnerability.UpdateVulnerability) error {
	type UpdateVulnerability struct {
		Old *entityVulnerability.Vulnerability `json:"old"`
		New *entityVulnerability.Vulnerability `json:"new"`
	}

	bodyVulnerability := &UpdateVulnerability{
		Old: vulnFound,
		New: &entityVulnerability.Vulnerability{
			VulnerabilityID: entityToUpdate.VulnerabilityID,
			Severity:        entityToUpdate.Severity,
			Type:            entityToUpdate.Type,
		},
	}
	body, _ := json.Marshal(bodyVulnerability)
	return c.broker.Publish("update-vulnerability", "", "", body)
}
